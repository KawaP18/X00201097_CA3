trigger:
- dev

pool:
  vmImage: 'ubuntu-latest'

stages:

# =========================
# CI STAGE — UNIT TESTS + SAST
# =========================
- stage: CI
  displayName: "CI - Tests & Security"
  jobs:

  - job: UnitTests
    displayName: "Run Pytest Unit Tests"
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'

    - script: |
        pip install -r requirements.txt
        export PYTHONPATH=$(System.DefaultWorkingDirectory)
        pytest --junitxml=unit-tests.xml
      displayName: "Install deps & run pytest"

    - task: PublishTestResults@2
      inputs:
        testResultsFiles: 'unit-tests.xml'
        testRunTitle: 'Unit Tests'
      condition: succeededOrFailed()

  - job: BanditScan
    displayName: "SAST - Bandit"
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'

    - script: |
        pip install bandit
        bandit -r calculator -f json -o bandit-report.json || true
      displayName: "Run Bandit scan"

    - publish: bandit-report.json
      artifact: security-report


# =========================
# PERFORMANCE TESTING — k6
# =========================
- stage: Performance
  displayName: "Performance Testing"
  dependsOn: CI
  condition: succeeded()
  jobs:
  - job: K6Tests
    displayName: "Run k6 load test"
    steps:
    - script: |
        sudo apt-get update
        sudo apt-get install -y ca-certificates gnupg
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://dl.k6.io/key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/k6.gpg
        echo "deb [signed-by=/etc/apt/keyrings/k6.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
        sudo apt-get update
        sudo apt-get install -y k6
        k6 run loadtest.js --out json=perf-results.json
      displayName: "Execute k6 test"

    - publish: perf-results.json
      artifact: performance-results


# =========================
# UAT — SELENIUM
# =========================
- stage: UAT
  displayName: "User Acceptance Testing"
  dependsOn: Performance
  condition: succeeded()
  jobs:
  - job: SeleniumUAT
    displayName: "Run Selenium tests"
    steps:
    - task: UsePythonVersion@0
      inputs:
        versionSpec: '3.10'

    - script: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google.list'
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
      displayName: "Install Chrome"

    - script: |
        pip install selenium
      displayName: "Install Selenium"

    - script: |
        python uat_tests/selenium_test.py
      displayName: "Run Selenium UAT"


# =========================
# DEPLOY TO TEST
# =========================
- stage: DeployTest
  displayName: "Deploy to TEST"
  dependsOn: UAT
  condition: succeeded()
  jobs:
  - deployment: DeployTestJob
    environment: Test
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo "Deploying to TEST environment"


# =========================
# DEPLOY TO PROD (APPROVAL)
# =========================
- stage: DeployProd
  displayName: "Deploy to PROD"
  dependsOn: DeployTest
  condition: succeeded()
  jobs:
  - deployment: DeployProdJob
    environment: Prod
    strategy:
      runOnce:
        deploy:
          steps:
          - script: echo "Deploying to PRODUCTION"
